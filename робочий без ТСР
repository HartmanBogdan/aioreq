import asyncio
import logging
import aiohttp
import numpy as np
import socket
import ssl
import datetime
import csv
from aiogram import Bot, Dispatcher, executor, types
from datetime import datetime

API_TOKEN = '5521564357:AAEyEl6zrML9PGMY-vunQesbEU0d4ZWdw1Y'
# Configure logging
logging.basicConfig(level=logging.INFO)

"""
set_time_up - —Ç–∞–π–º–µ—Ä –¥–ª—è –º–æ–Ω.—Å–∞–π—Ç—ñ–≤, –¥–∏–≤. help
set_time_ssl - —Ç–∞–π–º–µ—Ä –¥–ª—è SSL —Å–µ—Ä—Ç—Ñ. –¥–∏–≤. help
up_nacp - –ø–æ—á–∞—Ç–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Å–∞–π—Ç—ñ–≤
ssl_check_nacp - –ø–æ—á–∞—Ç–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ ssl
stop_ssl_check_nacp - –∑—É–ø–∏–Ω–∏—Ç–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ ssl
stop_up_nacp - –∑—É–ø–∏–Ω–∏—Ç–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Å–∞–π—Ç—ñ–≤
help - –ø–æ—è—Å–Ω–µ–Ω–Ω—è –¥–ª—è —Ç–∞–π–º–µ—Ä—ñ–≤
"""

# Initialize bot and dispatcher
bot = Bot(token=API_TOKEN)
dp = Dispatcher(bot)
sitepack_nacp = ['https://interes.shtab.net/',
                 'https://sanctions.nazk.gov.ua/',
                 'https://vision.nazk.gov.ua/',
                 'https://prosvita.nazk.gov.ua/',
                 'https://antycorportal.nazk.gov.ua/',
                 'https://study.nazk.gov.ua/',
                 'https://wiki.nazk.gov.ua/',
                 'https://nazk.gov.ua/uk/',
                 'https://erp.nazk.gov.ua/',
                 'https://jira.nazk.gov.ua/',
                 'https://confluence.nazk.gov.ua/',
                 'https://cloud.nazk.gov.ua',
                 'https://mail.nazk.gov.ua/mail/?_task=mail&_mbox=INBOX',
                 'https://nacpworkspace.slack.com/',
                 'http://interesshtasdab.neasdt/',
                 'https://asdasdasdsadasdasdes.shtab.net/',
                 'http://interes.shtab.net/']

nacp_sites = {
    'https://interes.shtab.net/': True,
    'https://sanctions.nazk.gov.ua/': True,
    'https://vision.nazk.gov.ua/': True,
    'https://prosvita.nazk.gov.ua/': True,
    'https://antycorportal.nazk.gov.ua/': True,
    'https://study.nazk.gov.ua/': True,
    'https://wiki.nazk.gov.ua/': True,
    'https://nazk.gov.ua/uk/': True,
    #'https://erp.nazk.gov.ua/': True,
    'https://jira.nazk.gov.ua/': True,
    #'https://confluence.nazk.gov.ua/': True,
    'https://cloud.nazk.gov.ua': True,
    #'https://mail.nazk.gov.ua/mail/?_task=mail&_mbox=INBOX': True,
    'https://nacpworkspace.slack.com/': True
}
down_time = {

}

sitepack = []
time_for_up = 60
time_for_ssl = 60
WhileLoopFlag = True
WhileLoopFlag_nacp = True
ssl_warning = 0

with open('logout.csv', 'a+', newline='', encoding='utf-8') as csvfile:
    fieldnames = ['–ù–∞–∑–≤–∞ –æ–ø–µ—Ä–∞—Ü—ñ—ó', '–†–µ–∑—É–ª—å—Ç–∞—Ç', '–ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è: –î–î/–ú–ú/–†–† –ì–æ–¥/–•–≤/–°–µ–∫']
    logger = csv.DictWriter(csvfile, fieldnames=fieldnames)
    logger.writerow({'–ù–∞–∑–≤–∞ –æ–ø–µ—Ä–∞—Ü—ñ—ó': "–ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞", '–†–µ–∑—É–ª—å—Ç–∞—Ç': " LOADED",
                     '–ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è: –î–î/–ú–ú/–†–† –ì–æ–¥/–•–≤/–°–µ–∫': (datetime.now()).strftime("%d:%m:%y %H:%M:%S")})


async def logger_writer(first_par, sec_par):
    with open('logout.csv', 'a+', newline='', encoding='utf-8') as csvfile:
        fieldnames = ['–ù–∞–∑–≤–∞ –æ–ø–µ—Ä–∞—Ü—ñ—ó', '–†–µ–∑—É–ª—å—Ç–∞—Ç', '–ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è: –î–î/–ú–ú/–†–† –ì–æ–¥/–•–≤/–°–µ–∫']
        logger = csv.DictWriter(csvfile, fieldnames=fieldnames)
        logger.writerow({'–ù–∞–∑–≤–∞ –æ–ø–µ—Ä–∞—Ü—ñ—ó': first_par, '–†–µ–∑—É–ª—å—Ç–∞—Ç': sec_par,
                         '–ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è: –î–î/–ú–ú/–†–† –ì–æ–¥/–•–≤/–°–µ–∫': time_func()})


def time_func():
    print(type((datetime.now()).strftime("%d.%m.%y %H:%M:%S")))
    return datetime.now()


# TIME FORMAT - str - strftime("%d.%m.%y %H:%M:%S")

def strfdelta(tdelta, fmt="{days} –¥–Ω. {hours} –≥–æ–¥. {minutes} —Ö–≤ {seconds} —Å–µ–∫."):
    d = {"days": tdelta.days}
    d["hours"], rem = divmod(tdelta.seconds, 3600)
    d["minutes"], d["seconds"] = divmod(rem, 60)
    return fmt.format(**d)


@dp.message_handler(commands=['set_time_up'], content_types=['text'])
async def set_time_up(message):
    print("before set_time")
    global time_for_up
    message.text = str(message.text).split(" ")[1]
    if 0 < int(message.text) <= 1440:
        time_for_up = int(message.text) * 60
        print("set time - " + str(time_for_up))
        await bot.send_message(message.chat.id, "–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∑–∞—Ç—Ä–∏–º–∫—É –º—ñ–∂ –≤–∏–≤–æ–¥–æ–º UP_SITE –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å - " + str(
            int(time_for_up / 60)) + " —Ö–≤.")
        await logger_writer(first_par="–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∑–∞—Ç—Ä–∏–º–∫—É –º—ñ–∂ –≤–∏–≤–æ–¥–æ–º UP_SITE –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å - " + str(
            int(time_for_up / 60)) + " —Ö–≤."
                            , sec_par=" —Ñ—É–Ω–∫—Ü—ñ—è : set_time_up")
    else:
        await bot.send_message(message.chat.id, "–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–µ –∑–Ω–∞—á–µ–Ω–Ω—è, –∑–Ω–∞—á–µ–Ω–Ω—è –º–æ–∂–µ –±—É—Ç–∏ –≤—ñ–¥ 0 –¥–æ 1440 —Ö–≤(–¥–æ–±–∞)")
        await logger_writer(first_par="–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–µ –∑–Ω–∞—á–µ–Ω–Ω—è: " + message.text +
                                      ", –∑–Ω–∞—á–µ–Ω–Ω—è –º–æ–∂–µ –±—É—Ç–∏ –≤—ñ–¥ 0 –¥–æ 1440 —Ö–≤(–¥–æ–±–∞)", sec_par=" —Ñ—É–Ω–∫—Ü—ñ—è set_time_up")


@dp.message_handler(commands=['set_time_ssl'], content_types=['text'])
async def set_time_ssl(message):
    print("before set_time")
    global time_for_ssl
    message.text = str(message.text).split(" ")[1]
    if 0 < int(message.text) <= 1440:
        time_for_ssl = int(message.text) * 60
        print("set time - " + str(time_for_ssl))
        await bot.send_message(message.chat.id, "–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∑–∞—Ç—Ä–∏–º–∫—É –º—ñ–∂ –≤–∏–≤–æ–¥–æ–º SSL –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å - " + str(
            int(time_for_ssl / 60)) + " —Ö–≤.")
        await logger_writer(first_par="–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∑–∞—Ç—Ä–∏–º–∫—É –º—ñ–∂ –≤–∏–≤–æ–¥–æ–º SSL –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å - ", sec_par=str(
            int(time_for_ssl / 60)) + " —Ö–≤. —Ñ—É–Ω–∫—Ü—ñ—è : set_time_ssl")

    else:
        await bot.send_message(message.chat.id, "–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–µ –∑–Ω–∞—á–µ–Ω–Ω—è, –∑–Ω–∞—á–µ–Ω–Ω—è –º–æ–∂–µ –±—É—Ç–∏ –≤—ñ–¥ 0 –¥–æ 1440 —Ö–≤("
                                                "–¥–æ–±–∞)")
        await logger_writer(first_par="–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–µ –∑–Ω–∞—á–µ–Ω–Ω—è: " + message.text +
                                      ", –∑–Ω–∞—á–µ–Ω–Ω—è –º–æ–∂–µ –±—É—Ç–∏ –≤—ñ–¥ 0 –¥–æ 1440 —Ö–≤(–¥–æ–±–∞)", sec_par=" —Ñ—É–Ω–∫—Ü—ñ—è set_time_ssl")


@dp.message_handler(commands=['stop_ssl_check_nacp'])
async def stop_ssl_check_nacp(message):
    global WhileLoopFlag
    WhileLoopFlag = False
    await bot.send_message(message.chat.id, text="–ó—É–ø–∏–Ω—è—î–º–æ –ø—Ä–æ—Ü–µ—Å –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ SSL")
    await logger_writer(first_par="–ó—É–ø–∏–Ω—è—î–º–æ –ø—Ä–æ—Ü–µ—Å –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ ", sec_par=' —Ñ—É–Ω–∫—Ü—ñ—è: stop_ssl_check_nacp')


@dp.message_handler(commands=['stop_up_nacp'])
async def stop_up_nacp(message: types.Message):
    global WhileLoopFlag_nacp
    WhileLoopFlag_nacp = False

    await bot.send_message(message.chat.id, text="–ó—É–ø–∏–Ω—è—î–º–æ –ø—Ä–æ—Ü–µ—Å –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ ")
    await logger_writer(first_par="–ó—É–ø–∏–Ω—è—î–º–æ –ø—Ä–æ—Ü–µ—Å –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ ", sec_par='—Ñ—É–Ω–∫—Ü—Ü—ñ—è: stop_up_nacp')


@dp.message_handler(commands=['up_nacp'])
async def up_nacp(message):
    # global sitepack_nacp
    global nacp_sites
    global time_for_up
    global down_time
    await bot.send_message(message.chat.id,
                           "–ó–∞–ø—É—Å–∫–∞—î–º–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É UP_SITE (1 —Ä–∞–∑ –Ω–∞ " + str(int(time_for_up) / 60) + " —Ö–≤)")
    await logger_writer(first_par="–ó–∞–ø—É—Å–∫–∞—î–º–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É UP_SITE ",
                        sec_par="(1 —Ä–∞–∑ –Ω–∞ " + str(int(time_for_up) / 60) + " —Ö–≤)")

    global WhileLoopFlag_nacp
    WhileLoopFlag_nacp = True
    while WhileLoopFlag_nacp is True:
        output = ""

        try:
            for key in nacp_sites:
                print(key)
                hostname = key.split('/')[2]
                try:
                    async with aiohttp.ClientSession() as session:
                        print(session._timeout)
                        try:
                            async with session.get(url=key, timeout=6) as response:
                                print(str(response.status) + " " + hostname)
                                if response.status != 200 and response.status != 401:
                                    output += (hostname + "  status_code: " + str(response.status) + " FAIL\n")
                                    if nacp_sites[key] is True:
                                        nacp_sites[key] = False
                                        down_time[key] = time_func()
                                        await bot.send_message(message.chat.id, "ALERT: DOWN üõë\n" +
                                                               hostname + "\nDown since: " +
                                                               str(down_time[key].strftime("%d.%m.%y %H:%M:%S")))
                                        await logger_writer(first_par=hostname,
                                                            sec_par="ALERT: DOWN üõë Down since:  "
                                                                    + str(down_time[key].strftime("%d.%m.%y %H:%M:%S")))

                                elif response.status == 200 or response.status == 401:
                                    if nacp_sites[key] is False:
                                        nacp_sites[key] = True
                                        deltatime = datetime.now() - down_time[key]
                                        await bot.send_message(message.chat.id, "RECOVERY: üü¢\n" + hostname + "\n" +
                                                               "–ë—É–≤ –≤–∏–º–∫–Ω–µ–Ω–∏–π –ø—Ä–æ—Ç—è–≥–æ–º "
                                                               + strfdelta(deltatime))
                                        await logger_writer(first_par=hostname,
                                                            sec_par="RECOVERY: üü¢ –ë—É–≤ –≤–∏–º–∫–Ω–µ–Ω–∏–π –ø—Ä–æ—Ç—è–≥–æ–º: "
                                                                    + str(down_time[key].strftime("%d.%m.%y %H:%M:%S")))


                        except asyncio.TimeoutError:
                            if nacp_sites[key] is True:
                                nacp_sites[key] = False
                                down_time[key] = time_func()
                                await bot.send_message(message.chat.id,
                                                       "ALERT: DOWN üõë\n" + hostname +
                                                       "\nReason: Connection Timeout\nDown since: "
                                                       + str(down_time[key].strftime("%d.%m.%y %H:%M:%S")))
                                await logger_writer(first_par=hostname,
                                                    sec_par="ALERT: DOWN üõë Connection Timeout. Down since: "
                                                            + str(down_time[key].strftime("%d.%m.%y %H:%M:%S")))

                            if (hostname + "  timeout fail \n") is not output:
                                output += (hostname + "  timeout fail \n")
                                print(output)
                except OSError:
                    print(hostname + " OSError")
                    if nacp_sites[key] is True:
                        nacp_sites[key] = False
                        down_time[key] = time_func()
                        await bot.send_message(message.chat.id,
                                               "ALERT: DOWN üõë\n" + hostname +
                                               "\nReason: OSError. Down since: " + str(
                                                   down_time[key].strftime("%d.%m.%y %H:%M:%S")) +
                                               "\n(–Ω–µ–º–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞)")
                        await logger_writer(first_par=hostname, sec_par="ALERT: DOWN üõë OSError. Down since: " + str(
                            down_time[key].strftime("%d.%m.%y %H:%M:%S")))

                        print(str(response.status) + "RESPONSE OSE EROOR STATUS")

        except TypeError:
            print(" TypeError")
        # await bot.send_message(message.chat.id, "–≤—Å–µ –æ–∫–µ–π")
        await asyncio.sleep(time_for_up)
    print(nacp_sites)
    await bot.send_message(message.chat.id, text="–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ UP_SITE –∑—É–ø–∏–Ω–µ–Ω–∞")
    await logger_writer(first_par="–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ UP_SITE –∑—É–ø–∏–Ω–µ–Ω–∞", sec_par=" —Ñ—É–Ω–∫—Ü—ñ—è up_nacp")

@dp.message_handler(commands=['ssl_check_nacp'])
async def ssl_check_nacp(message):
    global time_for_ssl
    await bot.send_message(message.chat.id,
                           "–ó–∞–ø—É—Å–∫–∞—î–º–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É SSL-—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ (1 —Ä–∞–∑ –Ω–∞ " + str(int(time_for_ssl) / 60) + " —Ö–≤)")
    await logger_writer(first_par="–ó–∞–ø—É—Å–∫–∞—î–º–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É SSL-—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ (1 —Ä–∞–∑ –Ω–∞ " + str(int(time_for_ssl) / 60) + " —Ö–≤)", sec_par=" —Ñ—É–Ω–∫—Ü—ñ—è ssl_check_nacp")

    global sitepack_nacp
    global nacp_sites
    global WhileLoopFlag
    WhileLoopFlag = True
    while WhileLoopFlag is True:
        out = ""
        try:
            for x in nacp_sites:
                hostname = x.split('/')[2]

                try:
                    async with aiohttp.ClientSession() as session:
                        try:
                            ssl_date_fmt = r'%b %d %H:%M:%S %Y %Z'
                            context = ssl.create_default_context()
                            conn = context.wrap_socket(socket.socket(socket.AF_INET), server_hostname=hostname, )
                            # TIMEOUT WAS 3.0
                            conn.settimeout(3.0)
                            conn.connect((hostname, 443))
                            ssl_info = conn.getpeercert()
                            Exp_ON = datetime.strptime(ssl_info['notAfter'], ssl_date_fmt)
                            Days_Remaining = Exp_ON - datetime.utcnow()
                            conn.close()
                            daysR = int(str(Days_Remaining).split(" ")[0])
                            if daysR <= 40:
                                out += (hostname + " " + str(daysR) + " üõë\n")
                            else:
                                out += (hostname + " " + str(daysR) + " üü¢\n")

                        except asyncio.TimeoutError:
                            out += hostname + " - TIMEOUT FAIL\n"
                            print(out)
                            await logger_writer(first_par=hostname + " - TIMEOUT FAIL", sec_par=" —Ñ—É–Ω–∫—Ü—ñ—è ssl_check_nacp")
                except OSError:

                    out += hostname + " - OSErorr\n"
                    print(out)
                    await logger_writer(first_par=hostname + " - OSErorr", sec_par=" —Ñ—É–Ω–∫—Ü—ñ—è ssl_check_nacp")
        except TypeError:
            print("TypeError")
        await bot.send_message(message.chat.id, out)
        await asyncio.sleep(time_for_ssl)

    await bot.send_message(message.chat.id, text="–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ SSL –∑—É–ø–∏–Ω–µ–Ω–∞")
    await logger_writer(first_par="–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ SSL –∑—É–ø–∏–Ω–µ–Ω–∞", sec_par=" —Ñ—É–Ω–∫—Ü—ñ—è ssl_check_nacp")



@dp.message_handler(commands=["help"])
async def help(message):
    await bot.send_message(message.chat.id,
                           "/set_time_up N, –¥–µ N - —á–∞—Å –≤ —Ö–≤–∏–ª–∏–Ω–∞—Ö —è–∫–∏–π –≤–∫–∞–∑—É—î –≤—ñ–¥—Ä—ñ–∑–æ–∫ —á–∞—Å—É –º—ñ–∂ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞–º–∏ –¥–æ—Å—Ç—É–ø—É "
                           "–¥–æ —Å–∞–π—Ç—É (default - 1).\n\n "
                           " –ü–û–¢–†–Ü–ë–ù–û –ü–†–û–ü–ò–°–£–í–ê–¢–ò –í–†–£–ß–ù–£, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥   '/set_time_up 50'   - –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –±—É–¥–µ –∫–æ–∂–Ω–∏—Ö 50—Ö–≤ "
                           "(–∑–Ω–∞—á–µ–Ω–Ω—è –º–æ–∂–µ –±—É—Ç–∏ –≤—ñ–¥ 1 –¥–æ 1440—Ö–≤(24–≥–æ–¥–∏–Ω–∏).\n\n"
                           "/set_time_ssl N, –¥–µ N - —á–∞—Å –≤ —Ö–≤–∏–ª–∏–Ω–∞—Ö —è–∫–∏–π –≤–∫–∞–∑—É—î –≤—ñ–¥—Ä—ñ–∑–æ–∫ —á–∞—Å—É –º—ñ–∂ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞–º–∏ SSL ("
                           "default - 1).\n\n "
                           " –ü–û–¢–†–Ü–ë–ù–û –ü–†–û–ü–ò–°–£–í–ê–¢–ò –í–†–£–ß–ù–£, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥   '/set_time_up 50'   - –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –±—É–¥–µ –∫–æ–∂–Ω–∏—Ö 50—Ö–≤ "
                           "(–∑–Ω–∞—á–µ–Ω–Ω—è –º–æ–∂–µ –±—É—Ç–∏ –≤—ñ–¥ 1 –¥–æ 1440—Ö–≤(24–≥–æ–¥–∏–Ω–∏).\n\n"
                           "/up_nacp - –ø–æ—á–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ —Å–∞–π—Ç—ñ–≤ –∫–æ–∂–Ω–∏—Ö N —Ö–≤–∏–ª–∏–Ω.\n\n"
                           "/ssl_check_nacp - –ø–æ—á–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É SSL –∫–æ–∂–Ω–∏—Ö N —Ö–≤–∏–ª–∏–Ω.\n\n"
                           "/stop_ssl_check_nacp - –∑—É–ø–∏–Ω–∏—Ç–∏ –ø–µ—Ä–≤—ñ—Ä–∫—É SSL.\n\n"
                           "/stop_up_nacp - –∑—É–ø–∏–Ω–∏—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ —Å–∞–π—Ç—ñ–≤.\n\n"
                           )
    await logger_writer(first_par="help –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–∞—Ç", sec_par=" —Ñ—É–Ω–∫—Ü—ñ—è help")


if __name__ == '__main__':
    executor.start_polling(dp, skip_updates=True)
